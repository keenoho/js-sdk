{"version":3,"file":"keenoho.umd.external.min.js","sources":["../src/config.js","../src/util.js","../src/request.js","../src/eventEmitter.js","../src/sdk.js","../index.js"],"sourcesContent":["export function loadConfig() {\r\n  let config = {\r\n    ENV: 'production',\r\n    API_HOST: 'http://api.keenoho.space',\r\n    APP_ID: 2000000000000000,\r\n  };\r\n\r\n  let configTarget = typeof document === 'object' ? window : typeof process === 'object' ? process && process.env || null : null\r\n\r\n  if (!configTarget) {\r\n    return configTarget\r\n  }\r\n  if ('ENV' in configTarget) {\r\n    config.ENV = configTarget.ENV\r\n  }\r\n  if ('API_HOST' in configTarget) {\r\n    config.API_HOST = configTarget.API_HOST\r\n  }\r\n  if ('APP_ID' in configTarget) {\r\n    config.APP_ID = configTarget.APP_ID\r\n  }\r\n\r\n  return config;\r\n}\r\n","import { HmacSHA1 } from 'crypto-js';\r\n\r\nexport function isBrowser() {\r\n  return typeof document === 'object';\r\n}\r\n\r\nexport function generateSign(app, ttl, ts, randId) {\r\n  const str = `${app}${ts}${ttl}${randId}`.split('').sort().join('');\r\n  return HmacSHA1(str, app.toString()).toString();\r\n}\r\n\r\nexport function generateSignature(url, app, token) {\r\n  const str = `${app}:${url}`.split('').sort().join('');\r\n  const res = HmacSHA1(str, token).toString();\r\n  return res;\r\n}\r\n\r\nexport function makeResponse(data = null, code = 0, msg = 'ok') {\r\n  return {\r\n    data,\r\n    code,\r\n    msg,\r\n    time: Date.now(),\r\n  };\r\n}\r\n","import axios from 'axios';\r\nimport { makeResponse } from './util';\r\n\r\nconst defaultAxiosOptions = {\r\n  url: '',\r\n  baseURL: '',\r\n  params: undefined,\r\n  data: undefined,\r\n  headers: undefined,\r\n  method: 'GET',\r\n};\r\n\r\nconst defualtRequestOptions = {\r\n  checkCode: true,\r\n  targetCode: 0,\r\n};\r\n\r\nexport function baseRequest(axiosOptions = defaultAxiosOptions, requestOptions = defualtRequestOptions) {\r\n  let { baseURL, url, params, data, headers, method } = Object.assign({}, defaultAxiosOptions, axiosOptions);\r\n  let { checkCode, targetCode } = Object.assign({}, defualtRequestOptions, requestOptions);\r\n\r\n  return new Promise((resolve, reject) => {\r\n    axios({\r\n      baseURL,\r\n      url,\r\n      params,\r\n      data,\r\n      headers,\r\n      method,\r\n    })\r\n      .then((res) => {\r\n        if (!res || !('data' in res)) {\r\n          throw makeResponse(null, -1, 'request error');\r\n        }\r\n        const resData = res.data;\r\n        if (checkCode) {\r\n          if (!('code' in resData)) {\r\n            throw makeResponse(null, -1, 'code is not in response');\r\n          }\r\n          if (resData.code !== targetCode) {\r\n            throw resData;\r\n          }\r\n        }\r\n        resolve(resData);\r\n      })\r\n      .catch((err) => {\r\n        let data = null;\r\n        let code = -1;\r\n        let msg = 'request error';\r\n\r\n        if (err && err.response && err.response.data) {\r\n          data = err?.response?.data?.data || data;\r\n          code = err?.response?.data?.code || code;\r\n          msg = err?.response?.data?.msg || msg;\r\n        } else if (err && 'data' in err) {\r\n          data = err?.data?.data || data;\r\n          code = err?.data?.code || code;\r\n          msg = err?.data?.msg || msg;\r\n        } else {\r\n          data = err?.data || data;\r\n          code = err?.code || code;\r\n          msg = err?.msg || msg;\r\n        }\r\n        let resData = makeResponse(data, code, msg);\r\n        reject(resData);\r\n      })\r\n      .finally(() => {});\r\n  });\r\n}\r\n","export default class EventEmitter {\r\n  constructor() {\r\n    this.eventMap = {};\r\n  }\r\n\r\n  on(event, callback) {\r\n    this.eventMap[event] = callback;\r\n  }\r\n\r\n  off(event, callback) {\r\n    delete this.eventMap[event];\r\n  }\r\n\r\n  emit(event, ...args) {\r\n    if (event in this.eventMap && typeof this.eventMap[event] === 'function') {\r\n      this.eventMap[event](...args);\r\n    }\r\n  }\r\n}\r\n","import { v4 as UUID } from 'uuid';\r\nimport { loadConfig } from './config';\r\nimport { baseRequest } from './request';\r\nimport { generateSign, generateSignature } from './util';\r\nimport EventEmitter from './eventEmitter';\r\n\r\nconst sdkDefaultAxiosOptions = {\r\n  url: '',\r\n  params: undefined,\r\n  data: undefined,\r\n  headers: undefined,\r\n  method: 'GET',\r\n};\r\n\r\nconst sdkDefualtRequestOptions = {\r\n  showLoading: false,\r\n  handleLoadingFunc: undefined,\r\n  showError: false,\r\n  handleErrorFunc: undefined,\r\n  checkCode: true,\r\n  targetCode: 0,\r\n};\r\n\r\nexport class SDK extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.event;\r\n    this.config = loadConfig();\r\n    this.token = undefined;\r\n    this.init();\r\n  }\r\n\r\n  async init() {\r\n    await this.initToken();\r\n    this.emit('ready', this);\r\n  }\r\n\r\n  async initToken(ttl = 7200) {\r\n    const baseURL = this.config.API_HOST;\r\n    const app = this.config.APP_ID;\r\n    const ts = Date.now();\r\n    const randId = UUID();\r\n    const sign = generateSign(app, ttl, ts, randId);\r\n    const { data } = await baseRequest({\r\n      baseURL,\r\n      url: '/v1/signature/token',\r\n      method: 'GET',\r\n      params: {\r\n        app,\r\n        ttl,\r\n        ts,\r\n        randId,\r\n        sign,\r\n      },\r\n    });\r\n    this.token = data;\r\n  }\r\n\r\n  async request(axiosOptions = sdkDefaultAxiosOptions, requestOptions = sdkDefualtRequestOptions) {\r\n    const aopt = Object.assign({}, sdkDefaultAxiosOptions, axiosOptions);\r\n    const ropt = Object.assign({}, sdkDefualtRequestOptions, requestOptions);\r\n\r\n    const token = this.token;\r\n    const baseURL = this.config.API_HOST;\r\n    const app = this.config.APP_ID;\r\n    const headers = {\r\n      'x-app': app,\r\n      'x-tk': token,\r\n      'x-sig': generateSignature(axiosOptions.url, app, token),\r\n    };\r\n\r\n    aopt.baseURL = baseURL;\r\n    aopt.headers = Object.assign(headers, aopt.headers);\r\n\r\n    return baseRequest(aopt, ropt);\r\n  }\r\n\r\n  async signatureTest() {\r\n    return this.request({\r\n      url: '/v1/signature/test',\r\n    });\r\n  }\r\n}\r\n","// import { isBrowser } from './src/util';\r\nimport * as config from './src/config';\r\nimport * as request from './src/request';\r\nimport { SDK } from './src/sdk';\r\n\r\n// browser auto load\r\n// function browserAutoLoad() {\r\n//   document.addEventListener('DOMContentLoaded', () => {\r\n//     const scriptEle = document.querySelector('script#keenoho');\r\n//     if (!scriptEle) {\r\n//       return;\r\n//     }\r\n//     const src = scriptEle.getAttribute('src');\r\n//     if (!src) {\r\n//       return;\r\n//     }\r\n//     const searchParams = new URLSearchParams(src.split('?')[1] || '');\r\n//     const search = {};\r\n//     for (let k of searchParams.keys()) {\r\n//       search[k] = searchParams.get(k);\r\n//     }\r\n//     if (search.autoLoad) {\r\n//       window.KEENOHO = new SDK(search);\r\n//     }\r\n//   });\r\n// }\r\n// if (isBrowser()) {\r\n//   browserAutoLoad();\r\n// }\r\n\r\nexport default {\r\n  config,\r\n  request,\r\n  SDK,\r\n};\r\n"],"names":["loadConfig","config","ENV","API_HOST","APP_ID","configTarget","_typeof","document","window","process","env","generateSign","app","ttl","ts","randId","str","concat","split","sort","join","HmacSHA1","toString","generateSignature","url","token","makeResponse","data","arguments","length","undefined","code","msg","time","Date","now","defaultAxiosOptions","baseURL","params","headers","method","defualtRequestOptions","checkCode","targetCode","baseRequest","axiosOptions","requestOptions","_Object$assign","Object","assign","_Object$assign2","Promise","resolve","reject","axios","then","res","resData","err","_err$response","_err$response2","_err$response3","response","_err$data","_err$data2","_err$data3","EventEmitter","_classCallCheck","this","eventMap","_createClass","key","value","event","callback","_this$eventMap","_len","args","Array","_key","apply","sdkDefaultAxiosOptions","sdkDefualtRequestOptions","showLoading","handleLoadingFunc","showError","handleErrorFunc","SDK","_EventEmitter","_inherits","_signatureTest","_request","_initToken","_init","_super","_createSuper","_this","call","init","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_context","prev","next","initToken","emit","stop","_callee2","sign","_yield$baseRequest","_args2","_context2","UUID","v4","sent","_callee3","aopt","ropt","_args3","_context3","abrupt","_callee4","_context4","request"],"mappings":"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"}